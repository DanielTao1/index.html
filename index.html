<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ğŸš€ StockGod Market </title>
    <style>
        :root {
            --background: #f8f9fa;
            --card-bg: #ffffff;
            --primary: #1652f0;
            --secondary: #808a9d;
            --success: #00d395;
            --danger: #ff4d4d;
            --text-primary: #1e2a3b;
            --text-secondary: #64748b;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            --border-radius: 16px;
        }

        body {
            margin: 0;
            padding: 12px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            color: var(--text-primary);
            background: var(--background);
        }

        .container {
            max-width: 580px;
            margin: 0 auto;
        }

        .balance-section {
            background: linear-gradient(135deg, #1652f0 0%, #1a43b6 100%);
            color: white;
            border-radius: var(--border-radius);
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: var(--shadow);
        }

        .card {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 20px;
            margin-bottom: 12px;
            box-shadow: var(--shadow);
        }

        .button {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.1s, opacity 0.2s;
        }

        .button:active {
            transform: scale(0.98);
        }

        .primary-btn {
            background: var(--primary);
            color: white;
        }

        .secondary-btn {
            background: var(--secondary);
            color: white;
        }

        .success-btn {
            background: var(--success);
            color: white;
        }

        .danger-btn {
            background: var(--danger);
            color: white;
        }

        .income-total {
            background: var(--success);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }

        .stock-item {
            padding: 16px;
            margin: 8px 0;
            background: var(--card-bg);
            border-radius: 12px;
            box-shadow: var(--shadow);
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.4);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background: white;
            width: 90%;
            max-width: 400px;
            border-radius: var(--border-radius);
            padding: 24px;
            position: relative;
        }

        .input-group {
            display: flex;
            gap: 8px;
            margin: 16px 0;
        }

        .input-group input {
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 12px;
            flex: 1;
            font-size: 16px;
        }

        .portfolio-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #f1f5f9;
        }

        /* æˆ¿å±‹å‡çº§æ ·å¼ */
        #homeModal .modal-content {
            max-width: 90%;
            min-width: 320px;
            padding: 20px;
            margin: 10px;
        }

        .home-level-container {
            display: flex;
            overflow-x: auto;
            gap: 20px;
            padding: 15px 0;
            width: 100%;
            scroll-behavior: smooth;
            -webkit-overflow-scrolling: touch;
        }

        .home-level-card {
            flex: 0 0 260px;
            background: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: var(--shadow);
            position: relative;
            min-height: 340px;
        }

        .home-level-card.current {
            border: 2px solid var(--success);
            box-shadow: 0 0 15px rgba(0, 211, 149, 0.3);
        }

        .home-preview {
            font-size: 3em;
            margin: 15px 0;
            background: #f3f4f6;
            border-radius: 8px;
            padding: 15px;
            min-height: 120px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .current-level-badge {
            position: absolute;
            top: -10px;
            right: -10px;
            background: var(--success);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            z-index: 1;
        }

        .home-asset-item {
            background: var(--card-bg);
            padding: 12px;
            border-radius: 12px;
            margin: 8px 0;
            box-shadow: var(--shadow);
        }

        .home-level-container::-webkit-scrollbar {
            height: 8px;
        }

        .home-level-container::-webkit-scrollbar-track {
            background: rgba(241, 245, 249, 0.5);
            border-radius: 4px;
        }

        .home-level-container::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }

        .home-level-container::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
    </style>
</head>
<body>
    <!-- ç™»å½•ç•Œé¢ -->
    <div id="loginView" class="container">
        <div class="card">
            <h2 style="margin-top: 0; text-align: center;">ğŸš€ StockGod Market</h2>
            <input type="text" id="username" placeholder="UserName">
            <input type="password" id="password" placeholder="PassWord">
            <div style="display: grid; gap: 8px; margin-top: 16px;">
                <button class="button primary-btn" onclick="login()">Login</button>
                <button class="button secondary-btn" onclick="register()">Register</button>
            </div>
        </div>
    </div>

    <!-- ä¸»ç•Œé¢ -->
    <div id="mainView" class="container" style="display: none;">
        <div class="balance-section">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <div style="font-size: 14px; opacity: 0.9;">Balance</div>
                    <div id="totalBalance" style="font-size: 32px; font-weight: 700;">$0.00</div>
                </div>
                <div class="income-total">
                    <span>ğŸ“ˆ $/Sec</span>
                    <span id="totalIncome">$0</span>
                </div>
            </div>
        </div>

        <div class="card">
            <div style="display: flex; justify-content: space-between; margin-bottom: 16px;">
                <h3 style="margin: 0;">ğŸ“Š Stock Market</h3>
                <div class="income-total" style="background: var(--primary);">
                    <span>ğŸ”„ å®æ—¶è¡Œæƒ…</span>
                </div>
            </div>
            <div id="stockList"></div>
        </div>

        <div class="card">
            <div style="display: flex; justify-content: space-between; margin-bottom: 16px;">
                <h3 style="margin: 0;">ğŸ’° èµ„äº§ç»„åˆ</h3>
                <div class="income-total" style="background: var(--primary);">
                    <span>ğŸ’¸ è¢«åŠ¨æ”¶å…¥</span>
                    <span id="passiveIncomeTotal">$0/ç§’</span>
                </div>
            </div>
            <div id="portfolioList"></div>
            <div style="display: grid; gap: 8px; margin-top: 16px;">
                <button class="button primary-btn" onclick="showShop()">ğŸª èµ„äº§å•†åŸ</button>
                <button class="button success-btn" onclick="showRedeem()">ğŸ å…‘æ¢å¥–åŠ±</button>
                <button class="button secondary-btn" onclick="showHistory()">ğŸ“œ äº¤æ˜“è®°å½•</button>
                <button class="button primary-btn" onclick="showHomeUpgrade()">ğŸ  æˆ‘çš„å®¶</button>
            </div>
        </div>
    </div>

    <!-- äº¤æ˜“å¼¹çª— -->
    <div id="tradeModal" class="modal">
        <div class="modal-content">
            <h3 style="margin-top: 0;" id="tradeTitle"></h3>
            <div style="background: #f8fafc; padding: 16px; border-radius: 12px;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                    <span>å½“å‰ä»·æ ¼</span>
                    <span id="stockPrice" style="font-weight: 600;"></span>
                </div>
                <div style="display: flex; justify-content: space-between; color: var(--text-secondary);">
                    <span id="availableBalanceLabel"></span>
                    <span id="availableBalance"></span>
                </div>
            </div>
            <div class="input-group">
                <input type="number" id="tradeAmount" min="1" value="1">
                <button class="button primary-btn" onclick="setMaxAmount()">MAX</button>
            </div>
            <div style="display: grid; gap: 8px;">
                <button class="button success-btn" onclick="confirmTrade()">ç¡®è®¤äº¤æ˜“</button>
                <button class="button danger-btn" onclick="closeModal()">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <!-- å†å²è®°å½•å¼¹çª— -->
    <div id="historyModal" class="modal">
        <div class="modal-content">
            <h3 style="margin-top: 0;">ğŸ“œ äº¤æ˜“è®°å½•</h3>
            <div id="historyList" style="max-height: 60vh; overflow-y: auto;"></div>
            <button class="button primary-btn" onclick="closeHistory()" style="margin-top: 16px;">å…³é—­</button>
        </div>
    </div>

    <!-- å•†åŸå¼¹çª— -->
    <div id="shopModal" class="modal">
        <div class="modal-content">
            <h3 style="margin-top: 0;">ğŸª èµ„äº§å•†åŸ</h3>
            <div id="shopItemsList" style="max-height: 60vh; overflow-y: auto;"></div>
            <button class="button primary-btn" onclick="closeShop()" style="margin-top: 16px;">å…³é—­</button>
        </div>
    </div>

    <!-- å…‘æ¢ç å¼¹çª— -->
    <div id="redeemModal" class="modal">
        <div class="modal-content">
            <h3 style="margin-top: 0;">ğŸ å…‘æ¢å¥–åŠ±ç </h3>
            <input type="text" id="redeemCode" placeholder="è¾“å…¥å…‘æ¢ç " class="input-full">
            <div style="display: grid; gap: 8px; margin-top: 16px;">
                <button class="button success-btn" onclick="redeemCode()">ç«‹å³å…‘æ¢</button>
                <button class="button danger-btn" onclick="closeRedeem()">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <!-- å‡ºå”®èµ„äº§å¼¹çª— -->
    <div id="sellAssetModal" class="modal">
        <div class="modal-content">
            <h3 style="margin-top: 0;" id="sellAssetTitle"></h3>
            <div style="background: #f8fafc; padding: 16px; border-radius: 12px;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                    <span>å‡ºå”®å•ä»·</span>
                    <span id="assetPrice" style="font-weight: 600;"></span>
                </div>
                <div style="display: flex; justify-content: space-between; color: var(--text-secondary);">
                    <span>æŒæœ‰æ•°é‡</span>
                    <span id="assetAmount"></span>
                </div>
            </div>
            <div class="input-group">
                <input type="number" id="sellAssetAmount" min="1" value="1">
                <button class="button primary-btn" onclick="setMaxAssetAmount()">MAX</button>
            </div>
            <div style="display: grid; gap: 8px;">
                <button class="button success-btn" onclick="confirmSellAsset()">ç¡®è®¤å‡ºå”®</button>
                <button class="button danger-btn" onclick="closeSellAssetModal()">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <!-- æˆ¿å±‹å‡çº§å¼¹çª— -->
    <div id="homeModal" class="modal">
        <div class="modal-content">
            <button class="button danger-btn" 
                    onclick="closeHome()" 
                    style="position: absolute; 
                           top: 10px; 
                           right: 10px; 
                           padding: 8px 12px;
                           z-index: 1001;">
                âœ– å…³é—­
            </button>
            <h3 style="margin-top: 0;">ğŸ  æˆ¿å±‹å‡çº§ç³»ç»Ÿ</h3>
            <div class="home-level-container" id="homeLevels"></div>
            <div class="card">
                <h4>å½“å‰æˆ¿å±‹ä¿¡æ¯</h4>
                <div class="home-preview" id="currentHomePreview"></div>
                <div>å½“å‰ç­‰çº§: <span id="currentHomeLevel">0</span> çº§</div>
                <div>æ¯ç§’æ”¶å…¥åŠ æˆ: +<span id="homeIncome">0</span>/ç§’</div>
            </div>
        </div>
    </div>

<script>
// è‚¡ç¥¨æ•°æ®
let stocks = [
    { name: "Tao Technology ğŸ’¾", price: 15000, initialPrice: 15000, capital: 1.5e11, trend: 0 },
    { name: "Medication LLC ğŸ§ª", price: 680, initialPrice: 680, capital: 6.8e8, trend: 0 },
    { name: "New EnergyğŸ”‹", price: 1500, initialPrice: 1500, capital: 1.5e10, trend: 0 },
    { name: "Tao Finace ğŸ¦", price: 8000, initialPrice: 8000, capital: 8e10, trend: 1 },
    { name: "Media NetworkğŸ›œ", price: 60, initialPrice: 60, capital: 6e8, trend: 0 },
    { name: "Tao Real Estate ğŸ¡", price: 100000, initialPrice: 100000, capital: 1e12, trend: 0 },
    { name: "Tao Fasion ğŸ‘—", price: 8, initialPrice: 8, capital: 8e7, trend: 0 },
    { name: "Travel World LLC ğŸ•ï¸", price: 110, initialPrice: 110, capital: 1.1e9, trend: 0 },
    { name: "Food International ğŸ±", price: 45, initialPrice: 45, capital: 4.5e8, trend: 0 },
    { name: "Tao Medication ğŸ§¬", price: 5000, initialPrice: 5000, capital: 5e10, trend: 0 }
];

// å•†åŸå•†å“
const shopItems = [
    { name: 'æ™®é€šæ±½è½¦å…¬å¸', price: 10000, income: 1, emoji: 'ğŸš—', desc: 'åŸºç¡€ä»£æ­¥å·¥å…·' },
    { name: 'ä¸­ç­‰æ±½è½¦å…¬å¸', price: 200000, income: 25, emoji: 'ğŸš™', desc: 'èˆ’é€‚å‡ºè¡Œä½“éªŒ' },
    { name: 'é«˜çº§æ±½è½¦å…¬å¸', price: 3000000, income: 650, emoji: 'ğŸš', desc: 'èº«ä»½çš„è±¡å¾' },
    { name: 'é™¶æ°è±ªåæ±½è½¦å…¬å¸', price: 30000000, income: 7000, emoji: 'ğŸï¸', desc: 'é™¶æ°è´µæ—çš„è±¡å¾' },
    { name: 'Tsaoå¥¶èŒ¶åº—', price: 300000, income: 40, emoji: 'ğŸ§‹', desc: 'å¥¶èŒ¶è¿é”å“ç‰Œ' },
    { name: '98Kæ±‰å ¡åº—', price: 500000, income: 80, emoji: 'ğŸ”', desc: 'æ±‰å ¡è¿é”å“ç‰Œ' },
    { name: 'ä¸­å›½å·èœåº—', price: 1000000, income: 200, emoji: 'ğŸ¥˜', desc: 'å·èœè¿é”å“ç‰Œ' },
    { name: 'é™¶æ°6æ˜Ÿç±³å…¶æ—é¤é¥®å…¬å¸', price: 100000000, income: 30000, emoji: 'ğŸ·ğŸ´', desc: 'é™¶æ°è¿é”å“ç‰Œ' },
    { name: 'æ™®é€šæˆ¿åœ°äº§å…¬å¸', price: 600000, income: 100, emoji: 'ğŸšï¸', desc: 'æ™®é€šä½å®…' },
    { name: 'ä¸­ç­‰æˆ¿åœ°äº§å…¬å¸', price: 2000000, income: 450, emoji: 'ğŸ ', desc: 'æ¸©é¦¨ä½å®…' },
    { name: 'é«˜çº§æˆ¿åœ°äº§å…¬å¸', price: 5000000, income: 1200, emoji: 'ğŸ ', desc: 'è±ªåå±…ä½ä½“éªŒ' },
    { name: 'é™¶æ°å¤§åˆ«å¢…åœ°äº§å…¬å¸', price: 60000000, income: 15000, emoji: 'ğŸ¡', desc: 'é™¶æ°è´µæ—å¤§åˆ«å¢…' }
];

// ç”¨æˆ·ç³»ç»Ÿ
let currentUser = null;
let currentUsername = null;
let currentTrade = null;
let currentSellItem = null;

function getUsers() {
    return JSON.parse(localStorage.getItem('users')) || {};
}

function saveUsers(users) {
    localStorage.setItem('users', JSON.stringify(users));
}

function saveUser() {
    const users = getUsers();
    users[currentUsername] = currentUser;
    saveUsers(users);
}

function loadUser(username) {
    const users = getUsers();
    return users[username] ? {
        password: users[username].password,
        balance: users[username].balance || 10000,
        portfolio: users[username].portfolio || {},
        properties: users[username].properties || {},
        history: users[username].history || [],
        redeemedCodes: users[username].redeemedCodes || [],
        homeLevel: users[username].homeLevel || 0
    } : null;
}

// æ³¨å†ŒåŠŸèƒ½
function register() {
    const username = document.getElementById('username').value.trim();
    const password = document.getElementById('password').value.trim();

    if (!username || !password) {
        alert('è¯·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ');
        return;
    }
    
    const users = getUsers();
    if (users[username]) {
        alert('ç”¨æˆ·åå·²å­˜åœ¨');
        return;
    }
    
    currentUser = {
        password: password,
        balance: 10000,
        portfolio: {},
        properties: {},
        history: [],
        redeemedCodes: [],
        homeLevel: 0
    };
    
    currentUsername = username;
    saveUser();
    alert('æ³¨å†ŒæˆåŠŸï¼Œè‡ªåŠ¨ç™»å½•');
    login();
}

// ç™»å½•åŠŸèƒ½
function login() {
    const username = document.getElementById('username').value.trim();
    const password = document.getElementById('password').value.trim();

    const users = getUsers();
    if (!users[username]) {
        alert('ç”¨æˆ·ä¸å­˜åœ¨');
        return;
    }
    if (users[username].password !== password) {
        alert('å¯†ç é”™è¯¯');
        return;
    }

    currentUsername = username;
    currentUser = loadUser(username);

    document.getElementById('loginView').style.display = 'none';
    document.getElementById('mainView').style.display = 'block';
    updateDisplay();
    startStockUpdates();
    startIncomeTimer();
}

// è‚¡ç¥¨ç³»ç»Ÿ
function startStockUpdates() {
    setInterval(() => {
        stocks.forEach(stock => {
            const prevPrice = stock.price;
            stock.price = Math.round(stock.price * (0.95 + Math.random() * 0.1) * 100) / 100;
            stock.trend = stock.price > prevPrice ? 1 : -1;
            stock.capital = Math.round(stock.capital * (0.98 + Math.random() * 0.04));
        });
        renderStocks();
        renderPortfolio();
    }, 1000);
}

function renderStocks() {
    const container = document.getElementById('stockList');
    container.innerHTML = stocks.map(stock => {
        const percentage = (
            ((stock.price - stock.initialPrice) / stock.initialPrice) * 100
        ).toFixed(2);
        
        return `
            <div class="stock-item">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <div style="font-weight: 600;">${stock.name}</div>
                        <div style="color: var(--text-secondary); font-size: 0.9em;">
                            å¸‚å€¼ï¼š$${stock.capital.toLocaleString()}
                        </div>
                    </div>
                    <div style="text-align: right;">
                        <div style="color: ${stock.trend > 0 ? 'var(--success)' : 'var(--danger)'}; 
                            font-weight: 600;">
                            $${stock.price.toFixed(2)}
                        </div>
                        <div style="font-size: 0.9em; color: var(--text-secondary);">
                            ${stock.trend > 0 ? 'ğŸ“ˆ' : 'ğŸ“‰'} 
                            ${percentage >= 0 ? '+' : '-'} 
                            ${Math.abs(percentage)}%
                        </div>
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 12px;">
                    <button class="button success-btn" 
                        onclick="showTrade('${stock.name}', 'buy')">ä¹°å…¥</button>
                    <button class="button danger-btn" 
                        onclick="showTrade('${stock.name}', 'sell')">å–å‡º</button>
                </div>
            </div>
        `;
    }).join('');
}

// èµ„äº§ç»„åˆ
function renderPortfolio() {
    const container = document.getElementById('portfolioList');
    let totalStockValue = 0;

    const stockContent = Object.keys(currentUser.portfolio).map(stockName => {
        const shares = currentUser.portfolio[stockName];
        const stock = stocks.find(s => s.name === stockName);
        const value = shares * stock.price;
        totalStockValue += value;
        return `
            <div class="portfolio-item">
                <div>
                    <div style="font-weight: 600;">${stockName}</div>
                    <div style="color: var(--text-secondary); font-size: 0.9em;">
                        æŒæœ‰ ${shares.toLocaleString()} è‚¡
                    </div>
                </div>
                <div style="text-align: right;">
                    <div style="color: var(--success);">$${value.toLocaleString(undefined, { maximumFractionDigits: 2 })}</div>
                    <div style="font-size: 0.9em; color: var(--text-secondary);">
                        @ $${stock.price.toFixed(2)}
                    </div>
                </div>
            </div>
        `;
    }).join('');

    const propertyContent = Object.keys(currentUser.properties).map(itemName => {
        const item = shopItems.find(i => i.name === itemName);
        const count = currentUser.properties[itemName];
        return `
            <div class="portfolio-item">
                <div>
                    <div style="font-weight: 600;">${item.emoji} ${itemName}</div>
                    <div style="color: var(--text-secondary); font-size: 0.9em;">
                        æ‹¥æœ‰ ${count}x
                    </div>
                </div>
                <div style="text-align: right;">
                    <div style="color: var(--success);">+$${(item.income * count).toLocaleString()}/ç§’</div>
                    <div style="font-size: 0.9em; color: var(--text-secondary);">
                        ä¼°å€¼ï¼š$${(item.price * count * 0.9).toLocaleString()}
                    </div>
                </div>
            </div>
        `;
    }).join('');

    // æ–°å¢æˆ¿å±‹èµ„äº§æ˜¾ç¤º
    const homeConfig = homeLevelsConfig.find(l => l.level === currentUser.homeLevel);
    const homeAsset = `
        <div class="home-asset-item">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <div style="font-weight: 600;">ğŸ  ${homeConfig.name}</div>
                    <div style="color: var(--text-secondary); font-size: 0.9em;">
                        ç­‰çº§ ${currentUser.homeLevel}
                    </div>
                </div>
                <div style="text-align: right;">
                    <div style="color: var(--success);">+$${homeConfig.income}/ç§’</div>
                    <div style="font-size: 0.9em; color: var(--text-secondary);">
                        ç´¯è®¡èŠ±è´¹ï¼š$${getHomeTotalCost().toLocaleString()}
                    </div>
                </div>
            </div>
        </div>
    `;

    const totalAssets = currentUser.balance + totalStockValue + getHomeTotalCost();
    document.getElementById('totalBalance').textContent = 
        `$${totalAssets.toLocaleString(undefined, { maximumFractionDigits: 2 })}`;

    container.innerHTML = `
        ${homeAsset}
        ${stockContent || '<div style="color:var(--text-secondary); text-align:center;">æš‚æ— è‚¡ç¥¨æŒä»“</div>'}
        ${propertyContent || ''}
    `;
}

// è¢«åŠ¨æ”¶å…¥ï¼ˆå·²æ•´åˆæˆ¿å±‹åŠ æˆï¼‰
function startIncomeTimer() {
    setInterval(() => {
        let totalIncome = 0;
        
        // èµ„äº§æ”¶å…¥
        Object.keys(currentUser.properties).forEach(itemName => {
            const item = shopItems.find(i => i.name === itemName);
            totalIncome += item.income * currentUser.properties[itemName];
        });
        
        // æˆ¿å±‹åŠ æˆ
        const homeConfig = homeLevelsConfig.find(l => l.level === currentUser.homeLevel);
        totalIncome += homeConfig.income;
        
        currentUser.balance += totalIncome;
        
        document.getElementById('totalIncome').textContent = `$${totalIncome.toLocaleString()}`;
        document.getElementById('passiveIncomeTotal').textContent = `$${totalIncome.toLocaleString()}/ç§’`;
        
        saveUser();
        updateDisplay();
    }, 1000);
}

// äº¤æ˜“ç³»ç»Ÿ
function showTrade(stockName, type) {
    currentTrade = { stock: stockName, type };
    const stock = stocks.find(s => s.name === stockName);
    
    document.getElementById('tradeTitle').textContent = 
        `${type === 'buy' ? 'ä¹°å…¥' : 'å–å‡º'} ${stockName}`;
    document.getElementById('stockPrice').textContent = 
        `$${stock.price.toFixed(2)}`;
    
    if (type === 'buy') {
        document.getElementById('availableBalanceLabel').textContent = 'å¯ç”¨ä½™é¢';
        document.getElementById('availableBalance').textContent = 
            `$${currentUser.balance.toLocaleString(undefined, { maximumFractionDigits: 2 })}`;
    } else {
        document.getElementById('availableBalanceLabel').textContent = 'æŒæœ‰æ•°é‡';
        document.getElementById('availableBalance').textContent = 
            `${currentUser.portfolio[stockName] || 0} è‚¡`;
    }
    
    document.getElementById('tradeModal').style.display = 'flex';
    document.getElementById('tradeAmount').value = 1;
}

function setMaxAmount() {
    if (currentTrade) {
        if (currentTrade.type === 'buy') {
            const stock = stocks.find(s => s.name === currentTrade.stock);
            const max = Math.floor(currentUser.balance / stock.price);
            document.getElementById('tradeAmount').value = max > 0 ? max : 1;
        } else {
            document.getElementById('tradeAmount').value = 
                currentUser.portfolio[currentTrade.stock] || 0;
        }
    }
}

function confirmTrade() {
    const amount = parseInt(document.getElementById('tradeAmount').value);
    if (isNaN(amount) || amount < 1) {
        alert('æ— æ•ˆçš„äº¤æ˜“æ•°é‡');
        return;
    }

    if (currentTrade) {
        const stock = stocks.find(s => s.name === currentTrade.stock);
        
        if (currentTrade.type === 'buy') {
            const cost = amount * stock.price;
            if (cost > currentUser.balance) {
                alert('èµ„é‡‘ä¸è¶³');
                return;
            }
            
            currentUser.balance -= cost;
            currentUser.portfolio[stock.name] = 
                (currentUser.portfolio[stock.name] || 0) + amount;
        } else {
            if (!currentUser.portfolio[stock.name] || 
                currentUser.portfolio[stock.name] < amount) {
                alert('æŒä»“ä¸è¶³');
                return;
            }
            
            currentUser.balance += amount * stock.price;
            currentUser.portfolio[stock.name] -= amount;
            
            if (currentUser.portfolio[stock.name] === 0) {
                delete currentUser.portfolio[stock.name];
            }
        }

        currentUser.history.push({
            type: currentTrade.type === 'buy' ? 'ä¹°å…¥è‚¡ç¥¨' : 'å–å‡ºè‚¡ç¥¨',
            name: stock.name,
            amount: amount,
            price: stock.price,
            total: amount * stock.price,
            time: new Date().toLocaleString()
        });
    }

    saveUser();
    updateDisplay();
    closeModal();
}

// å•†åŸç³»ç»Ÿ
function showShop() {
    const container = document.getElementById('shopItemsList');
    container.innerHTML = shopItems.map(item => {
        const owned = currentUser.properties[item.name] || 0;
        return `
            <div class="stock-item">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <div style="font-weight: 600;">${item.emoji} ${item.name}</div>
                        <div style="color: var(--text-secondary); font-size: 0.9em;">
                            ${item.desc}
                        </div>
                    </div>
                    <div style="text-align: right;">
                        <div style="color: var(--success);">+$${item.income}/ç§’</div>
                        <div style="font-size: 0.9em;">
                            $${item.price.toLocaleString()}
                        </div>
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 12px;">
                    ${owned > 0 ? `
                    <button class="button danger-btn" 
                        onclick="showSell('${item.name}')">
                        å‡ºå”® (æŒæœ‰ ${owned})
                    </button>` : ''}
                    <button class="button success-btn" 
                        onclick="buyItem('${item.name}')">
                        è´­ä¹°
                    </button>
                </div>
            </div>
        `;
    }).join('');
    document.getElementById('shopModal').style.display = 'flex';
}

function buyItem(itemName) {
    const item = shopItems.find(i => i.name === itemName);
    if (currentUser.balance < item.price) {
        alert('èµ„é‡‘ä¸è¶³');
        return;
    }
    
    currentUser.balance -= item.price;
    currentUser.properties[itemName] = (currentUser.properties[itemName] || 0) + 1;
    
    currentUser.history.push({
        type: 'è´­ä¹°èµ„äº§',
        name: itemName,
        price: item.price,
        time: new Date().toLocaleString()
    });
    
    saveUser();
    showShop();
    updateDisplay();
}

function showSell(itemName) {
    currentSellItem = itemName;
    const item = shopItems.find(i => i.name === itemName);
    const owned = currentUser.properties[itemName] || 0;
    
    document.getElementById('sellAssetTitle').textContent = `å‡ºå”® ${itemName}`;
    document.getElementById('assetPrice').textContent = 
        `$${(item.price * 0.9).toLocaleString()}`;
    document.getElementById('assetAmount').textContent = `${owned}x`;
    
    document.getElementById('sellAssetModal').style.display = 'flex';
    document.getElementById('sellAssetAmount').value = 1;
}

function confirmSellAsset() {
    const amount = parseInt(document.getElementById('sellAssetAmount').value);
    if (isNaN(amount) || amount < 1) {
        alert('æ— æ•ˆçš„æ•°é‡');
        return;
    }

    const item = shopItems.find(i => i.name === currentSellItem);
    const owned = currentUser.properties[currentSellItem] || 0;
    
    if (owned < amount) {
        alert('æŒæœ‰æ•°é‡ä¸è¶³');
        return;
    }
    
    const sellValue = Math.round(item.price * 0.9 * amount);
    currentUser.balance += sellValue;
    currentUser.properties[currentSellItem] -= amount;
    
    if (currentUser.properties[currentSellItem] === 0) {
        delete currentUser.properties[currentSellItem];
    }
    
    currentUser.history.push({
        type: 'å‡ºå”®èµ„äº§',
        name: currentSellItem,
        amount: amount,
        income: sellValue,
        time: new Date().toLocaleString()
    });
    
    currentSellItem = null;
    saveUser();
    updateDisplay();
    closeSellAssetModal();
    showShop();
}

function setMaxAssetAmount() {
    const owned = currentUser.properties[currentSellItem] || 0;
    document.getElementById('sellAssetAmount').value = owned;
}

// å…‘æ¢ç ç³»ç»Ÿ
const rewardCodes = {
    "WELCOME": 10000,
    "MILLIONAIRE": 1000000,
    "DANIELTAO": 10000000,
    "RICH2025": 20250,
    "TAOSTOCK": 100000
};

function showRedeem() {
    document.getElementById('redeemModal').style.display = 'flex';
}

function redeemCode() {
    const code = document.getElementById('redeemCode').value.trim().toUpperCase();
    
    if (!code) {
        alert('è¯·è¾“å…¥å…‘æ¢ç ');
        return;
    }
    if (currentUser.redeemedCodes.includes(code)) {
        alert('è¯¥å…‘æ¢ç å·²ä½¿ç”¨');
        return;
    }
    if (!rewardCodes[code]) {
        alert('æ— æ•ˆçš„å…‘æ¢ç ');
        return;
    }

    const amount = rewardCodes[code];
    currentUser.balance += amount;
    currentUser.redeemedCodes.push(code);
    
    currentUser.history.push({
        type: 'å…‘æ¢å¥–åŠ±',
        code: code,
        amount: amount,
        time: new Date().toLocaleString()
    });

    saveUser();
    updateDisplay();
    alert(`æˆåŠŸå…‘æ¢ $${amount.toLocaleString()}ï¼`);
    closeRedeem();
}

function closeRedeem() {
    document.getElementById('redeemModal').style.display = 'none';
}

// å†å²è®°å½•
function showHistory() {
    const container = document.getElementById('historyList');
    container.innerHTML = currentUser.history.reverse().map(record => {
        let content = '';
        const time = `<div style="font-size:0.8em;color:var(--text-secondary)">${record.time}</div>`;
        
        switch(record.type) {
            case 'ä¹°å…¥è‚¡ç¥¨':
                content = `
                    <div style="color:var(--success)">
                        ğŸ“ˆ ä¹°å…¥ ${record.name}
                    </div>
                    <div>æ•°é‡: ${record.amount.toLocaleString()} è‚¡</div>
                    <div>å•ä»·: $${record.price.toFixed(2)}</div>
                    <div>æ€»é¢: $${record.total.toLocaleString()}</div>
                `;
                break;
            case 'å–å‡ºè‚¡ç¥¨':
                content = `
                    <div style="color:var(--danger)">
                        ğŸ“‰ å–å‡º ${record.name}
                    </div>
                    <div>æ•°é‡: ${record.amount.toLocaleString()} è‚¡</div>
                    <div>å•ä»·: $${record.price.toFixed(2)}</div>
                    <div>æ€»é¢: $${record.total.toLocaleString()}</div>
                `;
                break;
            case 'è´­ä¹°èµ„äº§':
                content = `
                    <div style="color:var(--primary)">
                        ğŸª è´­ä¹° ${record.name}
                    </div>
                    <div>èŠ±è´¹: $${record.price.toLocaleString()}</div>
                `;
                break;
            case 'å‡ºå”®èµ„äº§':
                content = `
                    <div style="color:var(--danger)">
                        ğŸª å‡ºå”® ${record.name}
                    </div>
                    <div>æ•°é‡: ${record.amount}x</div>
                    <div>æ”¶å…¥: $${record.income.toLocaleString()}</div>
                `;
                break;
            case 'å…‘æ¢å¥–åŠ±':
                content = `
                    <div style="color:var(--success)">
                        ğŸ å…‘æ¢ç : ${record.code}
                    </div>
                    <div>è·å¾—: $${record.amount.toLocaleString()}</div>
                `;
                break;
            case 'æˆ¿å±‹å‡çº§':
                content = `
                    <div style="color:var(--primary)">
                        ğŸ  å‡çº§åˆ° ${record.level}çº§æˆ¿å±‹
                    </div>
                    <div>èŠ±è´¹: $${record.cost.toLocaleString()}</div>
                `;
                break;
        }

        return `
            <div class="card" style="margin:8px 0;padding:12px;">
                ${content}
                ${time}
            </div>
        `;
    }).join('') || '<div style="text-align:center;color:var(--text-secondary)">æš‚æ— è®°å½•</div>';
    
    document.getElementById('historyModal').style.display = 'flex';
}

// æˆ¿å±‹å‡çº§ç³»ç»Ÿ
const homeLevelsConfig = [
    { level: 0, name: "æ— å®¶å¯å½’", cost: 0, income: 0, preview: "ğŸ›ï¸ğŸŒŒ", description: "éœ²å®¿æ˜Ÿç©ºä¸‹" },
    { level: 1, name: "ç®€æ˜“æ£šå±‹", cost: 50000, income: 10, preview: "ğŸšï¸ğŸ›ï¸", description: "ç®€é™‹çš„æœ¨æ¿æˆ¿" },
    { level: 2, name: "æ¸©é¦¨å°å±‹", cost: 150000, income: 30, preview: "ğŸ ğŸ›‹ï¸ğŸ›ï¸", description: "åŸºç¡€å®¶å…·é½å…¨" },
    { level: 3, name: "ç°ä»£å…¬å¯“", cost: 500000, income: 100, preview: "ğŸ¢ğŸ›‹ï¸ğŸ“º", description: "ç°ä»£è£…ä¿®é£æ ¼" },
    { level: 4, name: "è”æ’åˆ«å¢…", cost: 1500000, income: 300, preview: "ğŸ˜ï¸ğŸŒ³ğŸš—", description: "å¸¦èŠ±å›­è½¦åº“" },
    { level: 5, name: "æ¹–æ™¯åˆ«å¢…", cost: 5000000, income: 1000, preview: "ğŸ¡ğŸŒŠâ›µ", description: "ç§äººæ¹–æ™¯é˜³å°" },
    { level: 6, name: "å±±é¡¶åº„å›­", cost: 15000000, income: 3000, preview: "ğŸ°â›°ï¸ğŸŠ", description: "å…¨æ™¯å±±æ™¯æ³³æ± " },
    { level: 7, name: "æ™ºèƒ½è±ªå®…", cost: 50000000, income: 10000, preview: "ğŸ˜ï¸ğŸ¤–ğŸš", description: "å…¨å±‹æ™ºèƒ½æ§åˆ¶" },
    { level: 8, name: "æµ·æ»¨å®«æ®¿", cost: 150000000, income: 30000, preview: "ğŸ¯ğŸŒ…â›±ï¸", description: "ç§äººæµ·æ»©é¢†åœ°" },
    { level: 9, name: "å¤©ç©ºä¹‹åŸ", cost: 500000000, income: 100000, preview: "ğŸ›¸ğŸŒŒâœ¨", description: "æ‚¬æµ®ç©ºä¸­åˆ«å¢…" },
    { level: 10, name: "æ˜Ÿé™…å ¡å’", cost: 1500000000, income: 300000, preview: "ğŸš€ğŸŒ ğŸª", description: "è·¨æ˜Ÿç³»å±…ä½ç«™" }
];

function showHomeUpgrade() {
    renderHomeLevels();
    updateCurrentHomeInfo();
    document.getElementById('homeModal').style.display = 'flex';
}

function renderHomeLevels() {
    const container = document.getElementById('homeLevels');
    container.innerHTML = homeLevelsConfig.map(level => {
        const isCurrent = level.level === currentUser.homeLevel;
        const canUpgrade = level.level === currentUser.homeLevel + 1;
        const hasEnoughMoney = currentUser.balance >= level.cost;
        
        return `
            <div class="home-level-card ${isCurrent ? 'current' : ''}">
                ${isCurrent ? `<div class="current-level-badge">å½“å‰ç­‰çº§</div>` : ''}
                <div class="home-preview">${level.preview}</div>
                <h4>${level.name}</h4>
                <div style="color: var(--text-secondary); margin: 8px 0;">
                    ç­‰çº§ ${level.level}
                </div>
                ${level.cost > 0 ? `
                    <div class="upgrade-cost">
                        ğŸ’° ${level.cost.toLocaleString()}
                    </div>
                ` : ''}
                <div style="font-size:0.9em; color:var(--text-secondary); margin: 12px 0;">
                    ${level.description}
                </div>
                ${canUpgrade ? `
                    <button class="button success-btn" 
                        ${!hasEnoughMoney ? 'disabled' : ''}
                        onclick="upgradeHome(${level.level})"
                        style="width:100%; position: absolute; bottom: 20px; left: 0; padding: 0 20px;">
                        ${hasEnoughMoney ? 'ç«‹å³å‡çº§' : 'èµ„é‡‘ä¸è¶³'}
                    </button>
                ` : ''}
            </div>
        `;
    }).join('');
}

function upgradeHome(targetLevel) {
    const targetConfig = homeLevelsConfig.find(l => l.level === targetLevel);
    if (!targetConfig) return alert('æ— æ•ˆçš„ç­‰çº§');
    if (currentUser.homeLevel + 1 !== targetLevel) return alert('è¯·æŒ‰é¡ºåºå‡çº§');
    if (currentUser.balance < targetConfig.cost) return alert('èµ„é‡‘ä¸è¶³');

    if (confirm(`ç¡®è®¤èŠ±è´¹ $${targetConfig.cost.toLocaleString()} å‡çº§åˆ° ${targetConfig.name} å—ï¼Ÿ`)) {
        currentUser.balance -= targetConfig.cost;
        currentUser.homeLevel = targetLevel;
        currentUser.history.push({
            type: 'æˆ¿å±‹å‡çº§',
            level: targetLevel,
            cost: targetConfig.cost,
            time: new Date().toLocaleString()
        });
        
        saveUser();
        updateDisplay();
        renderHomeLevels();
        updateCurrentHomeInfo();
        alert(`å‡çº§æˆåŠŸï¼å½“å‰æˆ¿å±‹ç­‰çº§ï¼š${targetLevel}çº§`);
    }
}

function updateCurrentHomeInfo() {
    const currentConfig = homeLevelsConfig.find(l => l.level === currentUser.homeLevel);
    document.getElementById('currentHomePreview').textContent = currentConfig.preview;
    document.getElementById('currentHomeLevel').textContent = currentUser.homeLevel;
    document.getElementById('homeIncome').textContent = currentConfig.income;
}

function getHomeTotalCost() {
    let total = 0;
    for(let i=0; i<=currentUser.homeLevel; i++) {
        total += homeLevelsConfig[i].cost;
    }
    return total;
}

function closeHome() {
    document.getElementById('homeModal').style.display = 'none';
}

// å·¥å…·å‡½æ•°
function closeModal() {
    document.getElementById('tradeModal').style.display = 'none';
}

function closeShop() {
    document.getElementById('shopModal').style.display = 'none';
}

function closeHistory() {
    document.getElementById('historyModal').style.display = 'none';
}

function closeSellAssetModal() {
    document.getElementById('sellAssetModal').style.display = 'none';
}

function updateDisplay() {
    document.getElementById('totalBalance').textContent = 
        `$${currentUser.balance.toLocaleString(undefined, { maximumFractionDigits: 2 })}`;

    let stockValue = 0;
    Object.entries(currentUser.portfolio).forEach(([name, shares]) => {
        const stock = stocks.find(s => s.name === name);
        stockValue += shares * stock.price;
    });

    const totalAssets = currentUser.balance + stockValue + getHomeTotalCost();
    document.getElementById('totalBalance').textContent = 
        `$${totalAssets.toLocaleString(undefined, { maximumFractionDigits: 2 })}`;

    renderPortfolio();
}

// åˆå§‹åŒ–
document.getElementById('loginView').style.display = 'block';
document.getElementById('mainView').style.display = 'none';
</script>
</body>
</html>
